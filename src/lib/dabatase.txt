-- Create users table (this will be managed by Supabase Auth, but we extend it)
CREATE TABLE IF NOT EXISTS public.users (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  spotify_id TEXT UNIQUE NOT NULL,
  email TEXT,
  display_name TEXT,
  spotify_access_token TEXT,
  spotify_refresh_token TEXT,
  token_expires_at BIGINT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create nuclei table
CREATE TABLE IF NOT EXISTS public.nuclei (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL DEFAULT 'The Nucleus',
  description TEXT,
  dominant_emotion TEXT,
  max_capacity INTEGER DEFAULT 15,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create tracks table
CREATE TABLE IF NOT EXISTS public.tracks (
  id BIGSERIAL PRIMARY KEY,
  nucleus_id BIGINT NOT NULL REFERENCES public.nuclei(id) ON DELETE CASCADE,
  spotify_id TEXT NOT NULL,
  spotify_url TEXT NOT NULL,
  title TEXT NOT NULL,
  artist TEXT,
  lyrics TEXT,
  genius_url TEXT,
  has_audio_preview BOOLEAN DEFAULT true,
  emotion TEXT NOT NULL,
  valence REAL,
  energy REAL,
  tempo INTEGER,
  genre TEXT,
  mood_description TEXT,
  dominant_instruments TEXT,
  vocal_characteristics TEXT,
  duration INTEGER,
  thumbnail_url TEXT,
  preview_url TEXT,
  added_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(nucleus_id, spotify_id)
);

-- Create chat_messages table
CREATE TABLE IF NOT EXISTS public.chat_messages (
  id BIGSERIAL PRIMARY KEY,
  nucleus_id BIGINT NOT NULL REFERENCES public.nuclei(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK(role IN ('user', 'assistant')),
  content TEXT NOT NULL,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  emotion TEXT DEFAULT NULL
);

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_nuclei_user_id ON public.nuclei(user_id);
CREATE INDEX IF NOT EXISTS idx_nuclei_is_active ON public.nuclei(is_active);
CREATE INDEX IF NOT EXISTS idx_tracks_nucleus_id ON public.tracks(nucleus_id);
CREATE INDEX IF NOT EXISTS idx_tracks_emotion ON public.tracks(emotion);
CREATE INDEX IF NOT EXISTS idx_chat_messages_nucleus_id ON public.chat_messages(nucleus_id);

-- Enable Row Level Security (RLS)
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.nuclei ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.tracks ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.chat_messages ENABLE ROW LEVEL SECURITY;

-- Create RLS policies
-- Users can only see and update their own data
CREATE POLICY "Users can view own data" ON public.users
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own data" ON public.users
  FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can insert own data" ON public.users
  FOR INSERT WITH CHECK (auth.uid() = id);

-- Users can only see their own nuclei
CREATE POLICY "Users can view own nuclei" ON public.nuclei
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own nuclei" ON public.nuclei
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own nuclei" ON public.nuclei
  FOR UPDATE USING (auth.uid() = user_id);

-- Users can only see tracks in their nuclei
CREATE POLICY "Users can view tracks in own nuclei" ON public.tracks
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.nuclei
      WHERE nuclei.id = tracks.nucleus_id
      AND nuclei.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can insert tracks in own nuclei" ON public.tracks
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.nuclei
      WHERE nuclei.id = tracks.nucleus_id
      AND nuclei.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can delete tracks in own nuclei" ON public.tracks
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM public.nuclei
      WHERE nuclei.id = tracks.nucleus_id
      AND nuclei.user_id = auth.uid()
    )
  );

-- Users can only see chat messages in their nuclei
CREATE POLICY "Users can view chat in own nuclei" ON public.chat_messages
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.nuclei
      WHERE nuclei.id = chat_messages.nucleus_id
      AND nuclei.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can insert chat in own nuclei" ON public.chat_messages
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.nuclei
      WHERE nuclei.id = chat_messages.nucleus_id
      AND nuclei.user_id = auth.uid()
    )
  );

-- Function to automatically update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- Create triggers for updated_at
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON public.users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_nuclei_updated_at BEFORE UPDATE ON public.nuclei
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();